# è…¾è®¯äº‘å¼€å‘äº‘å‡½æ•°ï½œæ¨¡ç‰ˆ

åŸºäºè…¾è®¯äº‘å¼€å‘çš„äº‘å‡½æ•°æ¨¡ç‰ˆï¼Œæ”¯æŒä»¥ä¸‹ç‰¹æ€§ï¼š

1. ğŸ§± ä½¿ç”¨ [koa](https://github.com/koajs/koa) æ¨¡æ‹Ÿè·¯ç”±ï¼Œè®©å•ä¸ªäº‘å‡½æ•°å°±èƒ½æ”¯æŒå¤šæ ·çš„ä¸šåŠ¡
2. ğŸ”¥ ä½¿ç”¨ typescript è¿›è¡Œå¼€å‘
3. ğŸ“¦ æ”¯æŒæ¥å…¥ mysql æ•°æ®åº“
4. ğŸ˜„ æ”¯æŒæœ¬åœ°å¼€å‘å’Œçƒ­æ›´æ–°ã€‚å¹¶ä¸äº§çº¿æ— ç¼å¯¹æ¥
5. ğŸš€ æ”¯æŒä¸€é”®éƒ¨ç½²è‡³è…¾è®¯äº‘å¼€å‘ç¯å¢ƒ
6. ğŸ” äº§çº¿ä»£ç åŠ å¯†ï¼Œäº¤ä»˜ç»™ç”²æ–¹æ— éœ€æ‹…å¿ƒæºç æ³„æ¼
7. ç­‰ç­‰

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥äº‘å‡½æ•°æ¨¡ç‰ˆåªæ˜¯ä¸º web server æä¾›äº†åŸºæœ¬èŒƒå¼ã€‚å¦‚æœå¸Œæœ›æœåŠ¡äºå¾®ä¿¡å°ç¨‹åºï¼Œå¹¶åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è°ƒè¯•ï¼Œè¯·å‚è€ƒ [blitz-wxapp-func](https://github.com/jay4q/blitz-wxapp-func)

## å¼€å‘é¡»çŸ¥

### 1. å‡†å¤‡å·¥ä½œ

1. å»ºè®®å¼€é€š [æŒ‰é‡è®¡è´¹ç¯å¢ƒ](https://cloud.tencent.com/document/product/876/39095) èµ„æºé…é¢è¾ƒé«˜ä¸”æœ‰å…è´¹ç¯å¢ƒ
2. å¤åˆ¶ [.env.example](./.env.example) ä¸º `.env.local` æ–‡ä»¶ï¼Œå¹¶æ ¹æ®æ³¨é‡Šé…ç½®ç¯å¢ƒå˜é‡
3. åŒä¸Šï¼Œå¤åˆ¶ [.env.db.example](./.env.db.example) ä¸º `.env.db.local` æ–‡ä»¶ï¼Œå¹¶æ ¹æ®æ³¨é‡Šé…ç½®ç¯å¢ƒå˜é‡
4. æ‰§è¡Œ `yarn` å®‰è£…ä¾èµ–

> ä¸ªäººå»ºè®®å¼€å‘ç¯å¢ƒå’Œäº§çº¿ç¯å¢ƒéš”ç¦»

### 2. å¼€å‘

1. æ‰§è¡Œ `yarn dev` å¼€å§‹å¼€å‘ï¼Œç›‘å¬ `7001` ç«¯å£
2. å¦‚æ–°å¢ã€ä¿®æ”¹é›†åˆï¼Œç›´æ¥åœ¨ [db.ts](./utils/db.ts) ä¸­å£°æ˜å³å¯ï¼Œå¹¶é€šè¿‡ `yarn deploy:db` åŒæ­¥æ›´æ–°å¼€å‘ç¯å¢ƒçš„äº‘æ•°æ®åº“é›†åˆ

### 3. éƒ¨ç½²

1. ç¡®ä¿å·²æ–°å¢ `.env.prod` æ–‡ä»¶å¹¶é…ç½®æ‰€éœ€çš„ç¯å¢ƒå˜é‡
2. ç¡®ä¿å·²å®‰è£… [cloudbase-cli](https://docs.cloudbase.net/cli-v1/install.html)
3. ä½¿ç”¨ `tcb login` ç™»å½•ç›¸åº”çš„è…¾è®¯äº‘è´¦å·ï¼ˆå¦‚æœå·²ç™»å½•åˆ™å¯ä»¥å¿½ç•¥ï¼‰
4. æ‰§è¡Œ `yarn deploy` å‘½ä»¤ï¼Œå°†äº‘å‡½æ•°éƒ¨ç½²è‡³äº§çº¿ï¼ˆé»˜è®¤å³å…¨é‡å‘å¸ƒï¼‰
5. å¯é€‰ï¼šæ‰§è¡Œ `yarn deploy:full` å‘½ä»¤ï¼Œå°†äº‘å‡½æ•°(JS)æºç éƒ¨ç½²è‡³äº§çº¿ã€‚åŒºåˆ«æ˜¯ï¼Œæ­¥éª¤4æœ€ç»ˆç¼–è¯‘å‡ºæ¥çš„ï¼Œåªæœ‰ä¸€ä¸ª `index.js` æ–‡ä»¶ï¼Œæå¤§ä¼˜åŒ–äº†äº‘å‡½æ•°ä½“ç§¯ã€åŠ å¿«äº†éƒ¨ç½²é€Ÿåº¦å¹¶ä¸€å®šç¨‹åº¦ä¸Šåšåˆ°äº†åŠ å¯†ï¼ˆå¯¹ç§æœ‰åŒ–éƒ¨ç½²å¾ˆå‹å¥½ï¼‰
6. å¯é€‰ï¼šåœ¨å·²æ–°å¢ `.env.db.prod` æ–‡ä»¶å¹¶é…ç½®æ‰€éœ€ç¯å¢ƒå˜é‡æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ `yarn deploy:db:prod` å‘½ä»¤ï¼Œå°†äº‘æ•°æ®åº“é›†åˆåŒæ­¥è‡³äº§çº¿ï¼ˆæ³¨æ„ä¸æ˜¯æ•°æ®ï¼Œæ˜¯é›†åˆåŒæ­¥ï¼‰

### 4. è¿ç»´

1. ç™»å½• [è…¾è®¯äº‘äº‘å¼€å‘æ§åˆ¶å°](https://console.cloud.tencent.com/) å¯¹åº”äº‘ç¯å¢ƒ
2. è¿›å…¥å½“å‰äº‘å‡½æ•°æŸ¥çœ‹ã€Œæ—¥å¿—ã€å’Œã€Œç›‘æ§ã€
3. å¯ä»¥æ ¹æ®å‰ç«¯å“åº”å¤´é‡Œçš„ `x-tencent-scf-request-id` å±æ€§ï¼Œåœ¨æ—¥å¿—ä¸­å®šä½å¯¹åº”è¯·æ±‚ï¼ŒæŸ¥çœ‹è¾“å‡ºçš„ç»“æœ

## Todo

+ [ ] å°†ä¸šåŠ¡ç›¸å…³ä»£ç ä»æ¨¡æ¿è·¯ç”±ä¸­ç§»é™¤ï¼ˆæ¯•ç«Ÿåªæ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œå¹¶ä¸æ˜¯è¯´æ•™äººå¦‚ä½•ç¼–å†™ä¸šåŠ¡ä»£ç ï¼‰ã€‚ä½†æ˜¯å¯ä»¥å‡ºä¸€ä¸ªç®€å•çš„æ•™ç¨‹ï¼Œæ•™å¯¼ç”¨æˆ·å¦‚ä½•ä½¿ç”¨
+ [ ] æ‰€æœ‰æ–°å¢å’Œæ›´æ–°æ“ä½œï¼Œéƒ½éœ€è¦å…ˆéªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦åŒ¹é…ã€æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦å¯ä»¥è€ƒè™‘ä½¿ç”¨ [zod](https://github.com/colinhacks/zod) åŒæ—¶å®Œæˆå®šä¹‰å’Œæ£€æŸ¥
+ [ ] é—¨æˆ·ç½‘ç«™é€»è¾‘
  + [ ] èœå•ç®¡ç†
  + [ ] æ–‡ç« ç®¡ç†

## å»ºè®®å’Œæ³¨æ„äº‹é¡¹

+ å¯é€‰ï¼šæ”¯æŒæ¥å…¥å…³ç³»å‹æ•°æ®åº“ï¼Œè¯¦è§ [ä»£ç ](./utils/sql.ts) ä»¥åŠ [serverless-mysql](https://github.com/jeremydaly/serverless-mysql)
+ å»ºè®®ï¼šå¦‚æœä¸šåŠ¡æ¯”è¾ƒå¤æ‚æˆ–è€…éœ€è¦å¼€å‘å°ç¨‹åºï¼Œå®¢æˆ·ç«¯ã€ç®¡ç†ç«¯æœåŠ¡å¯ä»¥åˆ†åˆ«éƒ¨ç½²ä¸ºä¸¤ä¸ªäº‘å‡½æ•°ï¼Œè¿™æ ·æ–¹ä¾¿ç®¡ç†
+ å»ºè®®ï¼šæ‰€æœ‰äº‘æ•°æ®åº“è¡¨åï¼Œéƒ½æ”¾åœ¨ [æ­¤å¤„](./utils/db.ts) ç»Ÿä¸€ç®¡ç†
+ å»ºè®®ï¼šé€šè¿‡è‡ªå®šä¹‰çŠ¶æ€ç ï¼Œè¦†ç›–æ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸æƒ…å†µã€‚å…¶ä½™å¼‚å¸¸éƒ½é€šè¿‡çŠ¶æ€ç  500 è¡¨ç¤ºã€‚åŒæ ·ç”±äºå‰ç«¯å‘èµ·çš„äº‘å‡½æ•°è¯·æ±‚ï¼Œå› æ­¤ä¹Ÿæ˜¯ä¸å­˜åœ¨éœ€è¦åˆ¤æ–­ HTTP çŠ¶æ€ç çš„æƒ…å†µ

### 1. å¦‚ä½•å‘è¿™ä¸ªäº‘å‡½æ•°å‘èµ·è¯·æ±‚

1. å¼€å‘ç¯å¢ƒä¸‹ï¼Œå‰ç«¯ç›´æ¥é€šè¿‡å¸¸ç”¨çš„ `axios ï½œ fetch | umi-request` å‘æœ¬åœ° web-server å‘èµ· http è¯·æ±‚å³å¯
2. äº§çº¿ç¯å¢ƒä¸‹ï¼ˆéƒ¨ç½²ä¸ºäº‘å‡½æ•°åï¼‰ï¼Œå‰ç«¯ç›´æ¥é€šè¿‡ [node-sdk](https://docs.cloudbase.net/api-reference/server/node-sdk/database/database.html) æä¾›çš„ `callFunction` å‘èµ·è¯·æ±‚

åŒæ ·ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ [blitz-admin](https://github.com/jay4q/blitz-admin) ä¸­çš„ `tcbRequest` å¯¹ä¸¤ç§æ–¹æ³•è¿›è¡Œå°è£…

ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºéœ€è¦å…¼å®¹ http è¯·æ±‚ï¼Œå› æ­¤éœ€è¦è§„èŒƒäº‘å‡½æ•°å…¥å‚ï¼Œè¯¦è§ [ä½¿ç”¨ HTTP è®¿é—®äº‘å‡½æ•°](https://docs.cloudbase.net/service/access-cloud-function.html)ã€‚ä¸‹é¢æ˜¯å¦‚ä½•å‘èµ·äº‘å‡½æ•°è¯·æ±‚çš„åŸºæœ¬èŒƒå¼ï¼Œä»¥ post è¯·æ±‚ä¸ºä¾‹ï¼š

``` ts
const body = typeof data === 'object' ? JSON.stringify(data) : data

const resp = await callFunction({
  parse: true,
  name: 'function-name',
  data: {
    body: data,
    httpMethod: 'POST',
    path: `/path/to/service`,
    headers: {
      ...(headers || {}),
      // è¿™é‡Œè¿˜å¯ä»¥æ”¾ä¸€äº›é‰´æƒä¿¡æ¯
    }
  }
})
```

### 2. ç”¨æˆ·æƒé™

> ç®¡ç†ç«¯

1. ç›®å‰åªè®¾è®¡äº† ç”¨æˆ·å’Œè§’è‰² ä¹‹é—´çš„å¤šå¯¹å¤šå…³ç³»ï¼Œæš‚ä¸æ”¯æŒç»†ç²’åº¦åœ°é…ç½®è§’è‰²æƒé™
2. å› æ­¤ï¼Œå°†è§’è‰²ç†è§£ä¸ºæ¨¡å—åŒ–å¤§æƒé™å³å¯ï¼Œä¾‹å¦‚æ–‡ç« è§’è‰²ï¼Œå¯ä»¥ç®¡ç†æ‰€æœ‰æ–‡ç« ç›¸å…³çš„èµ„æº
3. ä½¿ç”¨æ—¶è¯·éµå¾ªï¼š
   1. `*` è¡¨ç¤ºè¶…çº§ç®¡ç†å‘˜æƒé™
   2. å¦‚æœèµ„æºå†…å®¹éœ€è¦ä½¿ç”¨åˆ°ç›¸å…³è§’è‰²æƒé™ï¼Œè¯·åœ¨ç›¸å…³è·¯ç”±ä¸ŠåŠ ä¸Š [role-guard](./middlewares/role-guard.ts) è¿™ä¸ªä¸­é—´ä»¶ã€‚å¦‚æ–‡ç« è§’è‰²ï¼Œå¯ä»¥ `roleGuard('article')` è¿™æ ·ä½¿ç”¨

## æ³¨æ„äº‹é¡¹

+ ç›®å‰ä»…æ”¯æŒé€šè¿‡ [node-sdk](https://docs.cloudbase.net/api-reference/server/node-sdk/database/database.html) æ¥å…¥è…¾è®¯äº‘äº‘å¼€å‘
+ ä¸è¦ä½¿ç”¨ `export default` è€Œæ˜¯ç›´æ¥ä½¿ç”¨ `export` å¯¼å‡ºæ¨¡å—
+ ä¿®æ”¹ç¯å¢ƒå˜é‡åï¼Œéœ€è¦é‡æ–°å¯åŠ¨
+ å¾®ä¿¡äº‘å¼€å‘äº‘æ•°æ®åº“å­˜åœ¨ä¸€äº› [é™åˆ¶](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference/quota.html) å¼€å‘å‰éœ€è¦è¯„ä¼°

## ä¾èµ–

+ [koa-router](https://github.com/koajs/router/blob/master/API.md)
+ [serverless-mysql](https://github.com/jeremydaly/serverless-mysql)
+ [äº‘å‡½æ•°é…ç½®](https://docs.cloudbase.net/cli-v1/functions/configs.html)
+ [äº‘å‡½æ•°é™åˆ¶](https://cloud.tencent.com/document/product/876/47177#.E4.BA.91.E5.87.BD.E6.95.B0)
+ [äº‘å‡½æ•°ç´¢å¼•ä¼˜åŒ–](https://www.infoq.cn/article/mvc0m5ja5vfegfhsc7ks)
+ [äº‘æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–](https://developers.weixin.qq.com/community/business/doc/00068218a682088d17ca593c45b40d)
+ [nccå°†å·¥ç¨‹æœ€ç»ˆç¼–è¯‘ä¸ºä¸€ä¸ªJSæ–‡ä»¶](https://github.com/vercel/ncc)
