# è…¾è®¯äº‘å¼€å‘äº‘å‡½æ•°ï½œæ¨¡ç‰ˆ

åŸºäºè…¾è®¯äº‘å¼€å‘çš„äº‘å‡½æ•°æ¨¡ç‰ˆï¼Œæ”¯æŒä»¥ä¸‹ç‰¹æ€§ï¼š

1. ğŸ§± ä½¿ç”¨ [koa](https://github.com/koajs/koa) æ¨¡æ‹Ÿè·¯ç”±ï¼Œè®©å•ä¸ªäº‘å‡½æ•°å°±èƒ½æ”¯æŒå¤šæ ·çš„ä¸šåŠ¡
2. ğŸ”¥ ä½¿ç”¨ typescript è¿›è¡Œå¼€å‘
3. ğŸ“¦ æ”¯æŒæ¥å…¥ mysql æ•°æ®åº“
4. ğŸ˜„ æ”¯æŒæœ¬åœ°å¼€å‘å’Œçƒ­æ›´æ–°ã€‚å¹¶ä¸äº§çº¿æ— ç¼å¯¹æ¥
5. ğŸš€ åªéœ€ 20sï¼Œä¸€è¡Œå‘½ä»¤å³å¯éƒ¨ç½²è‡³è…¾è®¯äº‘å¼€å‘äº§çº¿ç¯å¢ƒ
6. ğŸ” äº§çº¿ä»£ç åŠ å¯†ï¼Œäº¤ä»˜ç»™ç”²æ–¹æ— éœ€æ‹…å¿ƒæºç æ³„æ¼
7. ç­‰ç­‰

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥äº‘å‡½æ•°æ¨¡ç‰ˆåªæ˜¯ä¸º web server æä¾›äº†åŸºæœ¬èŒƒå¼ã€‚å¦‚æœå¸Œæœ›æœåŠ¡äºå¾®ä¿¡å°ç¨‹åºï¼Œå¹¶åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è°ƒè¯•ï¼Œè¯·è”ç³»ä½œè€…è·å– `blitz-wxapp` æ¨¡æ¿

## æ–‡ä»¶ç»“æ„

- `scripts`: éƒ¨ç½²ç”¨çš„è„šæœ¬ï¼Œæ¨¡æ¿ä½¿ç”¨è€…æ— éœ€å…³æ³¨ï½
- `middlewares`: å­˜æ”¾äº†åŸºç¡€çš„ä¸­é—´ä»¶ã€‚ä¸šåŠ¡ä¸­é—´ä»¶ä¹Ÿå¯ä»¥å­˜æ”¾è‡³æ­¤å¤„
- `routes`: ä¸šåŠ¡è·¯ç”±ï¼Œä¸šåŠ¡å¼€å‘ä¸»è¦åœ¨è¿™é‡Œé¢è¿›è¡Œã€‚å‚è€ƒå¸¸ç”¨ restful/mvc æ ‡å‡†å³å¯
- `utils`: ä¸€äº›åŸºç¡€çš„å‡½æ•°åº“ã€‚ä¸šåŠ¡å¸¸ç”¨å‡½æ•°ä¹Ÿå¯ä»¥æ”¾äºæ­¤å¤„
- `.env.*`: ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ã€‚é€šè¿‡ `dotenv` è¯»å–
- `app.ts`: Koa åº”ç”¨å¯åŠ¨æ–‡ä»¶
- `server.ts`: æœ¬åœ°å¼€å‘çš„å…¥å£æ–‡ä»¶
- `index.js/ts`: äº§çº¿è¿è¡Œçš„å…¥å£æ–‡ä»¶
- `cloudbaserc.json`: éƒ¨ç½²è‡³è…¾è®¯äº‘å¼€å‘äº‘å‡½æ•°çš„é…ç½®æ–‡ä»¶

## ä½¿ç”¨æµç¨‹

### 1. å‡†å¤‡å·¥ä½œ

> ä¸ªäººå»ºè®®ï¼Œå¼€å‘/æµ‹è¯•è¿æ¥çš„äº‘å¼€å‘ç¯å¢ƒå’Œäº§çº¿çš„éš”ç¦»

1. å»ºè®®å¼€é€š [æŒ‰é‡è®¡è´¹ç¯å¢ƒ](https://cloud.tencent.com/document/product/876/39095) èµ„æºé…é¢è¾ƒé«˜ä¸”æœ‰å…è´¹ç¯å¢ƒ
2. å¤åˆ¶ `.env.example` ä¸º `.env.dev` å’Œ `.env.prod` æ–‡ä»¶ï¼Œå¹¶æ ¹æ®æ³¨é‡Šé…ç½®ç¯å¢ƒå˜é‡
3. å¤åˆ¶ `cloudbaserc.example.json` ä¸º `cloudbaserc.json`ï¼Œå¹¶æ ¹æ®éœ€è¦é…ç½®äº‘å¼€å‘å˜é‡ï¼ˆä¸€èˆ¬æ¥è¯´æ‹·è´è¿‡æ¥å°±èƒ½ç”¨äº†ï¼‰
4. æ‰§è¡Œ `yarn` å®‰è£…ä¾èµ–

#### ç¯å¢ƒå˜é‡è¯´æ˜

> è§ [.env.example](./.env.example)

- `TCB_SECRET_ID` å’Œ `TCB_SECRET_KEY` æ˜¯ä¸ºäº†è®©ç”¨æˆ·èƒ½å¤Ÿåœ¨æœ¬åœ°è®¿é—®äº‘å¼€å‘èµ„æºï¼ˆäº§çº¿å°±ä¸éœ€è¦é…ç½®äº†ï¼‰
  - å¯ä»¥åœ¨ [è®¿é—®ç®¡ç†->ç”¨æˆ·åˆ—è¡¨](https://console.cloud.tencent.com/cam) ä¸­è·å–
  - æ–°å»ºç”¨æˆ·æ—¶ï¼Œå…³è”ä¸Š **äº‘å¼€å‘** å…³é”®è¯çš„ç­–ç•¥å
  - åˆ›å»ºå®Œæˆåï¼Œç‚¹å¼€ç”¨æˆ·è¯¦æƒ…->API å¯†é’¥å³å¯è·å–
- `TCB_VPC_ID` å’Œ `TCB_VPC_SUBNET_ID` ä¸»è¦æœåŠ¡äºä½¿ç”¨è…¾è®¯äº‘ MYSQL çš„å¼€å‘è€…ã€‚å¯ä»¥å°†äº‘å‡½æ•°å’Œäº‘ Mysql é…ç½®åœ¨åŒä¸€ç§æœ‰ç½‘ç»œä¸‹ï¼Œå®ç°å†…ç½‘è®¿é—®
  - è‹¥ä¸éœ€è¦ï¼Œè¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡ä¸éœ€è¦å¡«
  - è‹¥ä¸éœ€è¦ï¼Œä¿®æ”¹ä¸‹ [cloudbaserc.json](./cloudbaserc.json)ï¼Œåˆ é™¤ `vpc` è¿™ä¸ªé…ç½®å³å¯

### 2. å¼€å‘

1. æ‰§è¡Œ `yarn dev` å¼€å§‹å¼€å‘ï¼Œç›‘å¬ `7001` ç«¯å£
2. å¯é€‰ï¼šä¿®æ”¹ `server.ts` æ–‡ä»¶å¯è‡ªå®šä¹‰ç«¯å£å·

### 3. éƒ¨ç½²

1. ç¡®ä¿å·²é…ç½® `.env.prod` æ–‡ä»¶
2. ç¡®ä¿å·²å®‰è£… [cloudbase-cli](https://docs.cloudbase.net/cli-v1/intro)
3. ä½¿ç”¨ `tcb login` ç™»å½•ç›¸åº”çš„è…¾è®¯äº‘è´¦å·ï¼ˆè‹¥å·²ç™»å½•ï¼Œå¯ä»¥å¿½ç•¥ï¼‰
   1. å»ºè®®å…ˆåœ¨æµè§ˆå™¨ç™»å½•è…¾è®¯äº‘ï¼Œcli ç™»å½•æ—¶ä¼šè‡ªåŠ¨é€šè¿‡æµè§ˆå™¨è…¾è®¯äº‘è¿›è¡Œ oauth
4. æ‰§è¡Œ `yarn deploy` å‘½ä»¤ï¼Œå°†äº‘å‡½æ•°éƒ¨ç½²è‡³äº§çº¿ï¼ˆé»˜è®¤å³å…¨é‡å‘å¸ƒï¼‰

### 4. è¿ç»´

1. ç™»å½• [è…¾è®¯äº‘äº‘å¼€å‘æ§åˆ¶å°](https://console.cloud.tencent.com/) å¯¹åº”äº‘ç¯å¢ƒ
2. è¿›å…¥å½“å‰äº‘å‡½æ•°æŸ¥çœ‹ã€æ—¥å¿—ã€‘å’Œã€ç›‘æ§ã€‘
3. å¯ä»¥æ ¹æ®å‰ç«¯å“åº”å¤´é‡Œçš„ `x-tencent-scf-request-id` å±æ€§ï¼Œåœ¨æ—¥å¿—ä¸­å®šä½å¯¹åº”è¯·æ±‚ï¼ŒæŸ¥çœ‹è¾“å‡ºçš„ç»“æœ

## æ³¨æ„äº‹é¡¹

- æ³¨æ„ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡æ–‡ä»¶åï¼Œéœ€è¦é‡æ–°å¯åŠ¨
- æ³¨æ„ï¼šç›®å‰ä»…æ”¯æŒé€šè¿‡ [node-sdk](https://docs.cloudbase.net/api-reference/server/node-sdk/database/database.html) æ¥å…¥è…¾è®¯äº‘äº‘å¼€å‘ã€‚è‹¥è¦é…åˆå°ç¨‹åºä½¿ç”¨ï¼Œè¯·å’¨è¯¢ä½¿ç”¨ `blitz-wxapp` ååŠ©å¼€å‘
- å»ºè®®ï¼šé€šè¿‡è‡ªå®šä¹‰çŠ¶æ€ç ï¼Œè¦†ç›–æ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸æƒ…å†µã€‚å…¶ä½™å¼‚å¸¸éƒ½é€šè¿‡çŠ¶æ€ç  500 è¡¨ç¤ºã€‚åŒæ ·ç”±äºå‰ç«¯å‘èµ·çš„äº‘å‡½æ•°è¯·æ±‚ï¼Œå› æ­¤ä¸å­˜åœ¨éœ€è¦åˆ¤æ–­ HTTP çŠ¶æ€ç çš„æƒ…å†µ
- å»ºè®®ï¼šä¸è¦ä½¿ç”¨ `export default` è€Œæ˜¯ç›´æ¥ä½¿ç”¨ `export` å¯¼å‡ºæ¨¡å—
- å¯é€‰ï¼šæ”¯æŒæ¥å…¥å…³ç³»å‹æ•°æ®åº“ï¼Œè¯¦è§ [ä»£ç ](./utils/sql.ts) ä»¥åŠ [serverless-mysql](https://github.com/jeremydaly/serverless-mysql)

### å¦‚ä½•å‘è¿™ä¸ªäº‘å‡½æ•°å‘èµ·è¯·æ±‚

- å¼€å‘ç¯å¢ƒä¸‹ï¼Œå‰ç«¯ç›´æ¥é€šè¿‡å¸¸ç”¨çš„ `axios ï½œ fetch | umi-request` å‘æœ¬åœ° web-server å‘èµ·è¯·æ±‚
- äº§çº¿ç¯å¢ƒä¸‹ï¼ˆéƒ¨ç½²ä¸ºäº‘å‡½æ•°åï¼‰ï¼Œå‰ç«¯ç›´æ¥é€šè¿‡ [jssdk](https://docs.cloudbase.net/api-reference/webv2/initialization) æä¾›çš„ `callFunction` å‘èµ·è¯·æ±‚ã€‚
  - â• éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†å…¼å®¹ [ä½¿ç”¨ HTTP è®¿é—®äº‘å‡½æ•°](https://docs.cloudbase.net/service/access-cloud-function)ï¼Œè¯¥æ¨¡æ¿è¦æ±‚äº‘å‡½æ•°å…¥å‚åŒ¹é… [é›†æˆè¯·æ±‚](https://docs.cloudbase.net/service/access-cloud-function#%E4%BA%91%E5%87%BD%E6%95%B0%E7%9A%84%E5%85%A5%E5%8F%82)ã€‚ä¸‹é¢æ˜¯å‰ç«¯å‘èµ·äº‘å‡½æ•°è¯·æ±‚çš„åŸºæœ¬èŒƒå¼

```ts
const body = typeof data === "object" ? JSON.stringify(data) : data;

const resp = await callFunction({
  parse: true,
  name: "function-name",
  data: {
    body: data,
    httpMethod: "POST",
    path: `/path/to/service`,
    headers: {
      ...(headers || {}),
      // è¿™é‡Œè¿˜å¯ä»¥æ”¾ä¸€äº›é‰´æƒä¿¡æ¯
    },
  },
});
```

## Todo

- [ ] æ‰€æœ‰æ–°å¢å’Œæ›´æ–°æ“ä½œï¼Œéƒ½éœ€è¦å…ˆéªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦åŒ¹é…ã€æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦å¯ä»¥è€ƒè™‘ä½¿ç”¨ [zod](https://github.com/colinhacks/zod) åŒæ—¶å®Œæˆå®šä¹‰å’Œæ£€æŸ¥

## å‚è€ƒ/ä¾èµ–

- [koa-router](https://github.com/koajs/router/blob/master/API.md)
- [serverless-mysql](https://github.com/jeremydaly/serverless-mysql)
- [äº‘å‡½æ•°é…ç½®](https://docs.cloudbase.net/cli-v1/functions/configs.html)
- [äº‘å‡½æ•°é™åˆ¶](https://cloud.tencent.com/document/product/876/47177#.E4.BA.91.E5.87.BD.E6.95.B0)
- [äº‘å‡½æ•°ç´¢å¼•ä¼˜åŒ–](https://www.infoq.cn/article/mvc0m5ja5vfegfhsc7ks)
- [äº‘æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–](https://developers.weixin.qq.com/community/business/doc/00068218a682088d17ca593c45b40d)
- [ncc å°†å·¥ç¨‹æœ€ç»ˆç¼–è¯‘ä¸ºä¸€ä¸ª JS æ–‡ä»¶](https://github.com/vercel/ncc)
